import { Aware, Statement } from "../interfaces/acl"
import { Storage } from "../interfaces/driver"
import { can } from "./helper"

export class UserAware implements Aware {
  constructor(public storage: Storage, public name: string) {
  }

  public async can(action: string, resource: string): Promise<boolean> {
    const user = await this.storage.getUser(this.name)
    if (user) {
      const policies = await Promise.all(
        (user.policies || []).map(policy => this.storage.getPolicy(policy))
      )
      const groups = await Promise.all(
        (user.groups || []).map(group => this.storage.getGroup(group))
      )
      const groupPolicies = await Promise.all(
        groups
          .reduce((carry, group) => [...carry, ...((group && group.policies) || [])], [] as string[])
          .map(policy => this.storage.getPolicy(policy))
      )
      const allows = [
        ...(user.allows || []),
        ...groups.reduce((carry, group) => {
          return [...carry, ...(group && group.allows) || []]
        }, [] as Statement[]),
        ...groupPolicies.reduce((carry, group) => {
          return [...carry, ...(group && group.allows) || []]
        }, [] as Statement[]),
        ...policies.reduce((carry, policy) => {
          return [...carry, ...(policy && policy.allows) || []]
        }, [] as Statement[]),
      ]
      const denies = [
        ...(user.denies || []),
        ...groups.reduce((carry, group) => {
          return [...carry, ...(group && group.denies) || []]
        }, [] as Statement[]),
        ...groupPolicies.reduce((carry, group) => {
          return [...carry, ...(group && group.denies) || []]
        }, [] as Statement[]),
        ...policies.reduce((carry, policy) => {
          return [...carry, ...(policy && policy.denies) || []]
        }, [] as Statement[]),
      ]
      return await can({allows: [...new Set(allows)], denies: [...new Set(denies)]}, action, resource)
    }
    return false
  }

  public async cannot(action: string, resource: string): Promise<boolean> {
    return !await this.can(action, resource)
  }
}
